<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user_style.css') }}">
    <title>KullanÄ±cÄ± Profili</title>
</head>
<body>
        {% include 'header.html' %}

        <div class="info-container">
        <section class="user-info">
            <h2>KullanÄ±cÄ± Bilgileri</h2>
            <button class="indentity-correct-button">KimliÄŸinizi DoÄŸrulayÄ±n</button>
            <div class="user-details">
                <div class="profile-picture-container">
                    <img src="{{ url_for('static', filename=user.profile_photo) }}" alt="Profil FotoÄŸrafÄ±" class="profile-picture">
                    <input type="file" id="profile-picture" name="profile-picture" accept="image/*" style="display:none;" onchange="updateProfilePicture()">
                    <button class="update-picture-btn" onclick="triggerFileInput()">ğŸ“¥</button>
                </div>
                <div class="user-details">
                    <div class="user-info-item">
                        <p>Ad: <span class="highlight" id="first-name">{{ user.first_name }}</span></p>
                        <button class="edit-btn" onclick="editField('first-name')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>Soyad: <span class="highlight" id="last-name">{{ user.last_name }}</span></p>
                        <button class="edit-btn" onclick="editField('last-name')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>Email: <span class="highlight " id="email">{{ user.email }}</span></p>
                        <button class="edit-btn" onclick="editField('email')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>KullanÄ±cÄ± AdÄ±: <span class="highlight" id="username">{{ user.username }}</span></p>
                        <button class="edit-btn" onclick="editField('username')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>Konum: <span class="highlight" id="location">{{ user.location }}</span></p>
                        <button class="edit-btn" onclick="editField('location')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                    <p>Ä°lgi AlanlarÄ±:
                    <span class="highlight" id="interests-display">
                        {% for interest in interests %}
                            {{ interest }}<br>
                        {% endfor %}
                    </span>
                </p>
                                        <button class="edit-btn" onclick="editField('interests')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>DoÄŸum Tarihi: <span class="highlight" id="birth-date">{{ user.birthday }}</span></p>
                        <button class="edit-btn" onclick="editField('birth-date')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>Cinsiyet: <span class="highlight" id="gender">{{ user.gender }}</span></p>
                        <button class="edit-btn" onclick="editField('gender')">âœï¸</button>
                    </div>
                    <div class="user-info-item">
                        <p>Telefon NumarasÄ±: <span class="highlight" id="phone-number">{{ user.phone_number }}</span></p>
                        <button class="edit-btn" onclick="editField('phone-number')">âœï¸</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <div class="event-container">
        <h2>OluÅŸturduÄŸunuz Etkinlikler</h2>
            <div class="event-list">
                {% for event in user_events %}
                    <div class="event-card">
                        <h3 class="event-title">{{ event['event_name'] }}</h3>
                        <p class="event-dates">
                            <strong>BaÅŸlangÄ±Ã§:</strong> {{ event['startDate'] }} / {{ event['startTime'] }} <br>
                            <strong>BitiÅŸ:</strong> {{ event['finishDate'] }} / {{ event['finishTime'] }}
                        </p>
                        <p class="event-location"><strong>Konum:</strong> {{ event['location'] }}</p>
                    </div>
                {% else %}
                    <p>OluÅŸturduÄŸunuz bir etkinlik bulunmamaktadÄ±r.</p>
                {% endfor %}
            </div>
        <h2>KatÄ±ldÄ±ÄŸÄ±nÄ±z Etkinlikler</h2>
                <div class="event-list">
                {% for event in user_events %}
                    <div class="event-card">
                        <h3 class="event-title">{{ event['event_name'] }}</h3>
                        <p class="event-dates">
                            <strong>BaÅŸlangÄ±Ã§:</strong> {{ event['startDate'] }} / {{ event['startTime'] }} <br>
                            <strong>BitiÅŸ:</strong> {{ event['finishDate'] }} / {{ event['finishTime'] }}
                        </p>
                        <p class="event-location"><strong>Konum:</strong> {{ event['location'] }}</p>
                    </div>
                {% else %}
                    <p>KatÄ±ldÄ±ÄŸÄ±nÄ±z bir etkinlik bulunmamaktadÄ±r.</p>
                {% endfor %}
            </div>
        <h2>Åifre Yenileme</h2>
        <div class="password-reset">
            <div>
                <label for="old-password">Eski Åifre:</label>
                <input type="password" id="old-password" name="old-password">
            </div>
            <div>
                <label for="new-password">Yeni Åifre:</label>
                <input type="password" id="new-password" name="new-password">
            </div>
            <div>
                <label for="confirm-new-password">Yeni Åifre Onaylama:</label>
                <input type="password" id="confirm-new-password" name="confirm-new-password">
            </div>
            <div>
                <button class="resetPassword" onclick="resetPassword()">Onayla</button>
            </div>
        </div>
    </div>

    <script>
        function toggleEditField() {
            var interestsOptions = document.getElementById('interests-options');
            interestsOptions.style.display = interestsOptions.style.display === 'none' ? 'block' : 'none';
        }

        function triggerFileInput() {
            document.getElementById('profile-picture').click();
        }

        function resetPassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            if (newPassword !== confirmNewPassword) {
                alert('Yeni ÅŸifreler eÅŸleÅŸmiyor!');
                return;
            }

            fetch('/resetPassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    oldPassword: oldPassword,
                    newPassword: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Åifre baÅŸarÄ±yla gÃ¼ncellendi!');
                } else {
                    alert('Eski ÅŸifre hatalÄ±. LÃ¼tfen tekrar deneyin.');
                }
            })
            .catch(error => console.error('Hata:', error));
        }

        function updateProfilePicture() {
            const fileInput = document.getElementById('profile-picture');
            const file = fileInput.files[0];

            if (!file) {
                alert('LÃ¼tfen bir profil resmi seÃ§in!');
                return;
            }

            const formData = new FormData();
            formData.append('profile-picture', file);

            fetch('/updateProfilePicture', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profil resmi baÅŸarÄ±yla gÃ¼ncellendi!');

                    const imgElement = document.querySelector('.profile-picture');
                    imgElement.src = data.newProfilePictureUrl;

                    window.location.reload();
                } else {
                    alert('Profil resmi gÃ¼ncellenirken bir hata oluÅŸtu.');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Bir hata oluÅŸtu.');
            });
        }

        let editMode = {};

        function editField(field) {
            const displayField = document.getElementById(`${field}-display`);
            const editField = document.getElementById(`${field}-edit`);

            displayField.style.display = 'none';
            editField.style.display = 'block';
        }

        function toggleInterests() {
            const interestsOptions = document.getElementById("interests-options");
            interestsOptions.style.display = interestsOptions.style.display === "block" ? "none" : "block";
        }

        function saveInterests() {
            const selectedInterestsContainer = document.getElementById("selected-interests");
            selectedInterestsContainer.innerHTML = "";

            const checkboxes = document.querySelectorAll(".interests-options input:checked");
            checkboxes.forEach(checkbox => {
                const interest = document.createElement("span");
                interest.textContent = checkbox.value;
                interest.classList.add("interest-tag");
                selectedInterestsContainer.appendChild(interest);
            });

            const displayField = document.getElementById("interests-display");
            const editField = document.getElementById("interests-edit");

            const newInterests = [];
            checkboxes.forEach(checkbox => {
                newInterests.push(checkbox.value);
            });

            let interestList = '<ul>';
            newInterests.forEach(interest => {
                interestList += `<li>${interest}</li>`;
            });
            interestList += '</ul>';

            displayField.innerHTML = interestList;

            displayField.style.display = 'block';
            editField.style.display = 'none';
        }

        function updateUserField(fieldId, updatedValue) {
            console.log(`GÃ¼ncellenen alan: ${fieldId}, Yeni DeÄŸer: ${updatedValue}`);

            fetch(`/updateUserField`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fieldId: fieldId,
                    value: updatedValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Veri baÅŸarÄ±yla gÃ¼ncellendi');
                } else {
                    alert('Veri gÃ¼ncellenirken bir hata oluÅŸtu.');
                }
            })
            .catch(error => console.error('Hata:', error));
        }
    </script>
</body>
</html>
